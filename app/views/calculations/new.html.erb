<div class="space-y-6">
  <!-- Header Section -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
    <h2 class="text-2xl font-bold text-gray-900 mb-2">
      Cost & Sustainability Calculator
    </h2>
    <p class="text-gray-600">
      Analyze SLM production costs, investment viability, and environmental
      impact with real-time data integration.
    </p>
  </div>

  <%= form_with model: @slicing_data, url: calculations_path, class: "space-y-6", data: {turbo:false} do |f| %>
    <!-- Machine Selection -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">
        1. Select Machine
      </h3>

      <% if f.object.errors[:machine].any? %>
        <div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
          <p class="text-sm text-red-800"><%= f.object.errors[:machine].first %></p>
        </div>
      <% end %>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <% @machines.each do |machine| %>
          <label class="cursor-pointer">
            <input
              type="radio"
              name="slicing_datum[machine_id]"
              value="<%= machine.id %>"
              class="peer hidden"
              required
            >
            <div
              class="
                border-2 border-gray-200 rounded-lg p-4 peer-checked:border-blue-500
                peer-checked:bg-blue-50 hover:border-blue-300 transition-colors
              "
            >
              <div class="flex items-center justify-between mb-3">
                <h4 class="font-semibold text-gray-900"><%= machine.name %></h4>
                <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">
                  <%= machine.model_number %>
                </span>
              </div>

              <dl class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <dt class="text-gray-500">Build Volume:</dt>
                  <dd class="font-medium text-gray-900">
                    <%= machine.build_volume_x.to_i %>×<%= machine.build_volume_y.to_i %><%= machine.build_volume_z.to_i %>
                    mm
                  </dd>
                </div>

                <div class="flex justify-between">
                  <dt class="text-gray-500">Laser Power:</dt>
                  <dd class="font-medium text-gray-900"><%= machine.laser_power.to_i %>
                    W</dd>
                </div>

                <div class="flex justify-between">
                  <dt class="text-gray-500">Purchase Price:</dt>
                  <dd class="font-medium text-gray-900">R
                    <%= number_to_human(machine.purchase_price, precision: 2) %></dd>
                </div>
              </dl>
            </div>
          </label>
        <% end %>
      </div>
    </div>
    <!-- Material Selection -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">
        2. Select Material
      </h3>

      <% if f.object.errors[:material].any? %>
        <div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
          <p class="text-sm text-red-800"><%= f.object.errors[:material].first %></p>
        </div>
      <% end %>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <% @materials.each do |material| %>
          <label class="cursor-pointer">
            <input
              type="radio"
              name="slicing_datum[material_id]"
              value="<%= material.id %>"
              class="peer hidden"
              required
            >
            <div
              class="
                border-2 border-gray-200 rounded-lg p-4 peer-checked:border-green-500
                peer-checked:bg-green-50 hover:border-green-300 transition-colors
              "
            >
              <div class="mb-3">
                <h4 class="font-semibold text-gray-900"><%= material.name %></h4>
                <p class="text-xs text-gray-500 mt-1"><%= material.code %></p>
              </div>

              <dl class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <dt class="text-gray-500">Density:</dt>
                  <dd class="font-medium text-gray-900"><%= material.density %>
                    g/cm³</dd>
                </div>

                <div class="flex justify-between">
                  <dt class="text-gray-500">Price:</dt>
                  <dd class="font-medium text-gray-900">R
                    <%= material.raw_material_price.to_i %>/kg</dd>
                </div>

                <div class="flex justify-between">
                  <dt class="text-gray-500">Recycling:</dt>
                  <dd class="font-medium text-gray-900"><%= (material.recycling_efficiency * 100).to_i %>%</dd>
                </div>

                <div class="flex justify-between">
                  <dt class="text-gray-500">Carbon:</dt>
                  <dd class="font-medium text-gray-900"><%= material.embodied_carbon %>
                    kg CO₂</dd>
                </div>
              </dl>
            </div>
          </label>
        <% end %>
      </div>
    </div>
    <!-- Part Geometry Parameters -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">
        3. Enter Part Geometry Parameters
      </h3>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div>
          <%= f.label :part_name,
                  "Part Name",
                  class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= f.text_field :part_name,
                       class:
                         "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",
                       placeholder: "e.g., Bracket-001" %>
          <% if f.object.errors[:part_name].any? %>
            <p class="mt-1 text-sm text-red-600"><%= f.object.errors[:part_name].first %></p>
          <% end %>
        </div>

        <div>
          <%= f.label :part_volume,
                  "Part Volume (mm³)",
                  class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= f.number_field :part_volume,
                         step: "0.01",
                         class:
                           "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",
                         placeholder: "e.g., 12500.00" %>
          <% if f.object.errors[:part_volume].any? %>
            <p class="mt-1 text-sm text-red-600"><%= f.object.errors[:part_volume].first %></p>
          <% end %>
        </div>

        <div>
          <%= f.label :part_height,
                  "Part Height (mm)",
                  class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= f.number_field :part_height,
                         step: "0.01",
                         class:
                           "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",
                         placeholder: "e.g., 45.00" %>
          <% if f.object.errors[:part_height].any? %>
            <p class="mt-1 text-sm text-red-600"><%= f.object.errors[:part_height].first %></p>
          <% end %>
        </div>

        <div>
          <%= f.label :surface_area,
                  "Surface Area (mm²)",
                  class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= f.number_field :surface_area,
                         step: "0.01",
                         class:
                           "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",
                         placeholder: "e.g., 8500.00" %>
          <% if f.object.errors[:surface_area].any? %>
            <p class="mt-1 text-sm text-red-600"><%= f.object.errors[:surface_area].first %></p>
          <% end %>
        </div>

        <div>
          <%= f.label :support_volume,
                  "Support Volume (mm³)",
                  class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= f.number_field :support_volume,
                         step: "0.01",
                         value: 0,
                         class:
                           "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",
                         placeholder: "e.g., 1500.00" %>
          <% if f.object.errors[:support_volume].any? %>
            <p class="mt-1 text-sm text-red-600"><%= f.object.errors[:support_volume].first %></p>
          <% end %>
        </div>

        <div>
          <%= f.label :layer_thickness,
                  "Layer Thickness (mm)",
                  class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= f.number_field :layer_thickness,
                         step: "0.001",
                         value: 0.03,
                         class:
                           "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",
                         placeholder: "e.g., 0.03" %>
          <% if f.object.errors[:layer_thickness].any? %>
            <p class="mt-1 text-sm text-red-600"><%= f.object.errors[:layer_thickness].first %></p>
          <% end %>
        </div>
      </div>
    </div>
    <!-- Production Parameters -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">
        4. Production Configuration
      </h3>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <%= f.label :parts_per_build,
                  "Parts per Build",
                  class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= f.number_field :parts_per_build,
                         value: 1,
                         min: 1,
                         class:
                           "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" %>
          <p class="mt-1 text-xs text-gray-500">How many parts will be produced in a single build?</p>
          <% if f.object.errors[:parts_per_build].any? %>
            <p class="mt-1 text-sm text-red-600"><%= f.object.errors[:parts_per_build].first %></p>
          <% end %>
        </div>

        <div>
          <%= f.label :material_utilization,
                  "Material Utilization Efficiency",
                  class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= f.number_field :material_utilization,
                         step: "0.01",
                         value: 0.6,
                         min: 0.1,
                         max: 1.0,
                         class:
                           "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" %>
          <p class="mt-1 text-xs text-gray-500">Typical range: 0.5-0.7 (50-70% efficiency)</p>
          <% if f.object.errors[:material_utilization].any? %>
            <p class="mt-1 text-sm text-red-600"><%= f.object.errors[:material_utilization].first %></p>
          <% end %>
        </div>
      </div>
    </div>

    <%= @slicing_data.errors.full_messages %>


<!-- Add this section after "Production Configuration" and before "Advanced Parameters" -->

<!-- Cost Line Items Section -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
  <div class="flex items-center justify-between mb-4">
    <h3 class="text-lg font-semibold text-gray-900">
      5. Cost Line Items (Optional - Auto-populated by default)
    </h3>
    <button
      type="button"
      onclick="document.getElementById('line-items-section').classList.toggle('hidden')"
      class="text-sm text-blue-600 hover:text-blue-800"
    >
      Toggle Line Items
    </button>
  </div>

  <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
    <p class="text-sm text-blue-800">
      <strong>ℹ️ Default Behavior:</strong> Cost line items will be automatically created based on your parameters. 
      Expand this section to add custom line items or modify the defaults after creation.
    </p>
  </div>

  <div id="line-items-section" class="hidden space-y-6">
    <!-- Labor Line Items -->
    <div class="border border-gray-200 rounded-lg p-4">
      <div class="flex items-center justify-between mb-3">
        <h4 class="font-medium text-gray-900 flex items-center">
          <span class="w-3 h-3 bg-blue-500 rounded-full mr-2"></span>
          Labor Costs
        </h4>
        <button
          type="button"
          onclick="addLineItem('labor')"
          class="text-sm px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200"
        >
          + Add Labor Item
        </button>
      </div>
      <div id="labor-line-items" class="space-y-2">
        <%= f.fields_for :cost_line_items, f.object.cost_line_items.select { |li| li.category == 'labor' } do |li_form| %>
          <%= render 'line_item_fields', f: li_form, category: 'labor' %>
        <% end %>
      </div>
    </div>

    <!-- Consumables Line Items -->
    <div class="border border-gray-200 rounded-lg p-4">
      <div class="flex items-center justify-between mb-3">
        <h4 class="font-medium text-gray-900 flex items-center">
          <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
          Consumables & Materials
        </h4>
        <button
          type="button"
          onclick="addLineItem('consumables')"
          class="text-sm px-3 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200"
        >
          + Add Consumable Item
        </button>
      </div>
      <div id="consumables-line-items" class="space-y-2">
        <%= f.fields_for :cost_line_items, f.object.cost_line_items.select { |li| li.category == 'consumables' } do |li_form| %>
          <%= render 'line_item_fields', f: li_form, category: 'consumables' %>
        <% end %>
      </div>
    </div>

    <!-- Energy Line Items -->
    <div class="border border-gray-200 rounded-lg p-4">
      <div class="flex items-center justify-between mb-3">
        <h4 class="font-medium text-gray-900 flex items-center">
          <span class="w-3 h-3 bg-yellow-500 rounded-full mr-2"></span>
          Energy Costs
        </h4>
        <button
          type="button"
          onclick="addLineItem('energy')"
          class="text-sm px-3 py-1 bg-yellow-100 text-yellow-700 rounded hover:bg-yellow-200"
        >
          + Add Energy Item
        </button>
      </div>
      <div id="energy-line-items" class="space-y-2">
        <%= f.fields_for :cost_line_items, f.object.cost_line_items.select { |li| li.category == 'energy' } do |li_form| %>
          <%= render 'line_item_fields', f: li_form, category: 'energy' %>
        <% end %>
      </div>
    </div>

    <!-- Equipment Line Items -->
    <div class="border border-gray-200 rounded-lg p-4">
      <div class="flex items-center justify-between mb-3">
        <h4 class="font-medium text-gray-900 flex items-center">
          <span class="w-3 h-3 bg-purple-500 rounded-full mr-2"></span>
          Equipment Costs
        </h4>
        <button
          type="button"
          onclick="addLineItem('equipment')"
          class="text-sm px-3 py-1 bg-purple-100 text-purple-700 rounded hover:bg-purple-200"
        >
          + Add Equipment Item
        </button>
      </div>
      <div id="equipment-line-items" class="space-y-2">
        <%= f.fields_for :cost_line_items, f.object.cost_line_items.select { |li| li.category == 'equipment' } do |li_form| %>
          <%= render 'line_item_fields', f: li_form, category: 'equipment' %>
        <% end %>
      </div>
    </div>

    <!-- Facility Line Items -->
    <div class="border border-gray-200 rounded-lg p-4">
      <div class="flex items-center justify-between mb-3">
        <h4 class="font-medium text-gray-900 flex items-center">
          <span class="w-3 h-3 bg-indigo-500 rounded-full mr-2"></span>
          Facility & Overhead
        </h4>
        <button
          type="button"
          onclick="addLineItem('facility')"
          class="text-sm px-3 py-1 bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200"
        >
          + Add Facility Item
        </button>
      </div>
      <div id="facility-line-items" class="space-y-2">
        <%= f.fields_for :cost_line_items, f.object.cost_line_items.select { |li| li.category == 'facility' } do |li_form| %>
          <%= render 'line_item_fields', f: li_form, category: 'facility' %>
        <% end %>
      </div>
    </div>

    <!-- Digital Infrastructure Line Items -->
    <div class="border border-gray-200 rounded-lg p-4">
      <div class="flex items-center justify-between mb-3">
        <h4 class="font-medium text-gray-900 flex items-center">
          <span class="w-3 h-3 bg-cyan-500 rounded-full mr-2"></span>
          Digital Infrastructure
        </h4>
        <button
          type="button"
          onclick="addLineItem('digital')"
          class="text-sm px-3 py-1 bg-cyan-100 text-cyan-700 rounded hover:bg-cyan-200"
        >
          + Add Digital Item
        </button>
      </div>
      <div id="digital-line-items" class="space-y-2">
        <%= f.fields_for :cost_line_items, f.object.cost_line_items.select { |li| li.category == 'digital' } do |li_form| %>
          <%= render 'line_item_fields', f: li_form, category: 'digital' %>
        <% end %>
      </div>
    </div>

    <!-- Maintenance Line Items -->
    <div class="border border-gray-200 rounded-lg p-4">
      <div class="flex items-center justify-between mb-3">
        <h4 class="font-medium text-gray-900 flex items-center">
          <span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span>
          Maintenance Costs
        </h4>
        <button
          type="button"
          onclick="addLineItem('maintenance')"
          class="text-sm px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200"
        >
          + Add Maintenance Item
        </button>
      </div>
      <div id="maintenance-line-items" class="space-y-2">
        <%= f.fields_for :cost_line_items, f.object.cost_line_items.select { |li| li.category == 'maintenance' } do |li_form| %>
          <%= render 'line_item_fields', f: li_form, category: 'maintenance' %>
        <% end %>
      </div>
    </div>
  </div>
</div>

<script>
  let lineItemCounters = {
    labor: <%= f.object.cost_line_items.select { |li| li.category == 'labor' }.size %>,
    consumables: <%= f.object.cost_line_items.select { |li| li.category == 'consumables' }.size %>,
    energy: <%= f.object.cost_line_items.select { |li| li.category == 'energy' }.size %>,
    equipment: <%= f.object.cost_line_items.select { |li| li.category == 'equipment' }.size %>,
    facility: <%= f.object.cost_line_items.select { |li| li.category == 'facility' }.size %>,
    digital: <%= f.object.cost_line_items.select { |li| li.category == 'digital' }.size %>,
    maintenance: <%= f.object.cost_line_items.select { |li| li.category == 'maintenance' }.size %>
  };

  function addLineItem(category) {
    const container = document.getElementById(`${category}-line-items`);
    const newIndex = new Date().getTime(); // Unique index
    
    const lineItemHtml = `
      <div class="grid grid-cols-12 gap-2 p-3 bg-gray-50 rounded border border-gray-200 nested-fields">
        <input type="hidden" name="slicing_datum[cost_line_items_attributes][${newIndex}][category]" value="${category}" />
        
        <div class="col-span-3">
          <input 
            type="text" 
            name="slicing_datum[cost_line_items_attributes][${newIndex}][name]"
            placeholder="Item name"
            class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500"
          />
        </div>
        
        <div class="col-span-3">
          <input 
            type="text" 
            name="slicing_datum[cost_line_items_attributes][${newIndex}][description]"
            placeholder="Description"
            class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500"
          />
        </div>
        
        <div class="col-span-2">
          <input 
            type="number" 
            step="0.01"
            name="slicing_datum[cost_line_items_attributes][${newIndex}][unit_cost]"
            placeholder="Unit cost"
            class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500"
          />
        </div>
        
        <div class="col-span-1">
          <input 
            type="number" 
            step="0.01"
            name="slicing_datum[cost_line_items_attributes][${newIndex}][quantity]"
            placeholder="Qty"
            value="1"
            class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500"
          />
        </div>
        
        <div class="col-span-2">
          <select 
            name="slicing_datum[cost_line_items_attributes][${newIndex}][unit_type]"
            class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500"
          >
            <option value="hours">Hours</option>
            <option value="kg">kg</option>
            <option value="kWh">kWh</option>
            <option value="m³">m³</option>
            <option value="per_build">Per Build</option>
            <option value="per_part">Per Part</option>
            <option value="units">Units</option>
          </select>
        </div>
        
        <div class="col-span-1 flex items-center justify-center">
          <button 
            type="button" 
            onclick="this.closest('.nested-fields').remove()"
            class="text-red-600 hover:text-red-800 text-sm font-bold"
            title="Remove item"
          >
            ✕
          </button>
        </div>
      </div>
    `;
    
    container.insertAdjacentHTML('beforeend', lineItemHtml);
    lineItemCounters[category]++;
  }

  function removeLineItemField(button) {
    const field = button.closest('.nested-fields');
    const destroyCheckbox = field.querySelector('.destroy-checkbox');
    
    if (destroyCheckbox) {
      // Mark for destruction if persisted
      destroyCheckbox.checked = true;
      field.style.display = 'none';
    } else {
      // Remove if not yet saved
      field.remove();
    }
  }
</script>




    <!-- Advanced Parameters (Collapsible) -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-900">
          5. Advanced Parameters (Optional)
        </h3>
        <button
          type="button"
          onclick="document.getElementById('advanced-params').classList.toggle('hidden')"
          class="text-sm text-blue-600 hover:text-blue-800"
        >
          Toggle Advanced Settings
        </button>
      </div>

      <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
        <div class="flex items-start">
          <%= f.check_box :use_custom_parameters, class: "mt-1 mr-2" %>
          <%= f.label :use_custom_parameters, class: "text-sm text-blue-800" do %>
            <span class="font-medium">Use custom parameters for this analysis</span>
            <span class="block text-xs mt-1">
              By default, global parameters are used. Enable this to override
              with custom values below.
            </span>
          <% end %>
        </div>
      </div>

      <div id="advanced-params" class="hidden space-y-6">
        <!-- Economic Parameters -->
        <div>
          <h4 class="font-medium text-gray-900 mb-3">Economic Parameters</h4>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <%= f.label :electricity_rate,
                      "Electricity Rate (R/kWh)",
                      class: "block text-sm text-gray-700 mb-1" %>
              <%= f.number_field :electricity_rate,
                             step: "0.01",
                             class:
                               "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
            </div>
            <div>
              <%= f.label :labor_rate,
                      "Labor Rate (R/hr)",
                      class: "block text-sm text-gray-700 mb-1" %>
              <%= f.number_field :labor_rate,
                             step: "0.01",
                             class:
                               "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
            </div>
            <div>
              <%= f.label :annual_operating_hours,
                      "Annual Operating Hours",
                      class: "block text-sm text-gray-700 mb-1" %>
              <%= f.number_field :annual_operating_hours,
                             step: "1",
                             class:
                               "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
            </div>
          </div>
        </div>
        <!-- Gas & Consumables -->
        <div>
          <h4 class="font-medium text-gray-900 mb-3">Gas & Consumables</h4>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <%= f.label :inert_gas_price,
                      "Inert Gas Price (R/m³)",
                      class: "block text-sm text-gray-700 mb-1" %>
              <%= f.number_field :inert_gas_price,
                             step: "0.01",
                             class:
                               "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
            </div>
            <div>
              <%= f.label :gas_consumption_per_hour,
                      "Gas Consumption (m³/hr)",
                      class: "block text-sm text-gray-700 mb-1" %>
              <%= f.number_field :gas_consumption_per_hour,
                             step: "0.001",
                             class:
                               "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
            </div>
            <div>
              <%= f.label :waste_disposal_cost_per_kg,
                      "Waste Disposal (R/kg)",
                      class: "block text-sm text-gray-700 mb-1" %>
              <%= f.number_field :waste_disposal_cost_per_kg,
                             step: "0.01",
                             class:
                               "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
            </div>
          </div>
        </div>
        <!-- Facility Costs -->
        <div>
          <h4 class="font-medium text-gray-900 mb-3">Facility Costs (Annual)</h4>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <%= f.label :annual_rent, "Rent (R/year)", class: "block text-sm text-gray-700 mb-1" %>
              <%= f.number_field :annual_rent,
                             step: "0.01",
                             class:
                               "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
            </div>
            <div>
              <%= f.label :annual_utilities,
                      "Utilities (R/year)",
                      class: "block text-sm text-gray-700 mb-1" %>
              <%= f.number_field :annual_utilities,
                             step: "0.01",
                             class:
                               "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
            </div>
            <div>
              <%= f.label :annual_admin,
                      "Admin (R/year)",
                      class: "block text-sm text-gray-700 mb-1" %>
              <%= f.number_field :annual_admin,
                             step: "0.01",
                             class:
                               "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
            </div>
          </div>
        </div>
        <!-- Digital Infrastructure -->
        <div>
          <h4 class="font-medium text-gray-900 mb-3">Digital Infrastructure (Annual)</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <%= f.label :annual_software_cost,
                      "Software Licenses (R/year)",
                      class: "block text-sm text-gray-700 mb-1" %>
              <%= f.number_field :annual_software_cost,
                             step: "0.01",
                             class:
                               "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
            </div>
            <div>
              <%= f.label :annual_hpc_cost,
                      "HPC Systems (R/year)",
                      class: "block text-sm text-gray-700 mb-1" %>
              <%= f.number_field :annual_hpc_cost,
                             step: "0.01",
                             class:
                               "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
            </div>
          </div>
        </div>

        <!-- Maintenence -->
        <div>
          <h4 class="font-medium text-gray-900 mb-3">Maintenance<h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <%= f.label :preventive_maintenance_cost,
                      "Preventive Maintenance Cost (R)",
                      class: "block text-sm text-gray-700 mb-1" %>
              <%= f.number_field :preventive_maintenance_cost,
                             step: "0.01",
                             class:
                               "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
            </div>
            <div>
              <%= f.label :preventive_maintenance_frequency,
                      class: "block text-sm text-gray-700 mb-1" %>
              <%= f.number_field :preventive_maintenance_frequency,
                             step: "1",
                             class:
                               "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
            </div>

            <div>
              <%= f.label :corrective_maintenance_cost,
                      "Corrective Maintenance Cost (R)",
                      class: "block text-sm text-gray-700 mb-1" %>
              <%= f.number_field :corrective_maintenance_cost,
                             step: "0.01",
                             class:
                               "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
            </div>
            <div>
              <%= f.label :corrective_maintenance_frequency,
                      class: "block text-sm text-gray-700 mb-1" %>
              <%= f.number_field :corrective_maintenance_frequency,
                             step: "1",
                             class:
                               "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
            </div>
          </div>
        </div>
        <!-- Build Parameters -->
        <div>
          <h4 class="font-medium text-gray-900 mb-3">Build & Process Parameters</h4>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <%= f.label :machine_power_consumption,
                      "Machine Power (kW)",
                      class: "block text-sm text-gray-700 mb-1" %>
              <%= f.number_field :machine_power_consumption,
                             step: "0.1",
                             class:
                               "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
            </div>
            <div>
              <%= f.label :setup_time_hours,
                      "Setup Time (hours)",
                      class: "block text-sm text-gray-700 mb-1" %>
              <%= f.number_field :setup_time_hours,
                             step: "0.1",
                             class:
                               "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
            </div>
            <div>
              <%= f.label :post_processing_time_per_part,
                      "Post-Processing (hrs/part)",
                      class: "block text-sm text-gray-700 mb-1" %>
              <%= f.number_field :post_processing_time_per_part,
                             step: "0.1",
                             class:
                               "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
            </div>
          </div>
        </div>
        <!-- Sustainability -->
        <div>
          <h4 class="font-medium text-gray-900 mb-3">Sustainability Parameters</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <%= f.label :grid_emission_factor,
                      "Grid Emission Factor (kg CO₂/kWh)",
                      class: "block text-sm text-gray-700 mb-1" %>
              <%= f.number_field :grid_emission_factor,
                             step: "0.001",
                             class:
                               "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
            </div>
          </div>
        </div>

<div>
  <h4 class="font-medium text-gray-900 mb-3">Financial Analysis Parameters</h4>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div>
      <%= f.label :price_per_part,
              "Price per Part (R)",
              class: "block text-sm text-gray-700 mb-1" %>
      <%= f.number_field :price_per_part,
                     step: "0.01",
                     class:
                       "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
      <p class="mt-1 text-xs text-gray-500">Selling price per part</p>
    </div>
    
    <div>
      <%= f.label :discount_rate,
              "Discount Rate",
              class: "block text-sm text-gray-700 mb-1" %>
      <%= f.number_field :discount_rate,
                     step: "0.01",
                     min: "0",
                     max: "1",
                     class:
                       "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
      <p class="mt-1 text-xs text-gray-500">E.g., 0.10 for 10%</p>
    </div>
    
    <div>
      <%= f.label :analysis_horizon_years,
              "Analysis Horizon (Years)",
              class: "block text-sm text-gray-700 mb-1" %>
      <%= f.number_field :analysis_horizon_years,
                     step: "1",
                     min: "1",
                     class:
                       "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
      <p class="mt-1 text-xs text-gray-500">Typical: 5-10 years</p>
    </div>
    
    <div>
      <%= f.label :upfront_investment,
              "Upfront Investment (R)",
              class: "block text-sm text-gray-700 mb-1" %>
      <%= f.number_field :upfront_investment,
                     step: "1000",
                     class:
                       "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
      <p class="mt-1 text-xs text-gray-500">Initial capital investment</p>
    </div>
    
    <div>
      <%= f.label :machine_utilization_rate,
              "Machine Utilization Rate",
              class: "block text-sm text-gray-700 mb-1" %>
      <%= f.number_field :machine_utilization_rate,
                     step: "0.01",
                     min: "0",
                     max: "1",
                     class:
                       "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
      <p class="mt-1 text-xs text-gray-500">E.g., 0.75 for 75% utilization</p>
    </div>
    
    <div>
      <%= f.label :minimum_acceptable_return,
              "Minimum Acceptable Return (%)",
              class: "block text-sm text-gray-700 mb-1" %>
      <%= f.number_field :minimum_acceptable_return,
                     step: "0.1",
                     class:
                       "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
      <p class="mt-1 text-xs text-gray-500">Hurdle rate for investment</p>
    </div>
  </div>
</div>

<div>
  <h4 class="font-medium text-gray-900 mb-3">Monte Carlo Risk Analysis</h4>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div>
      <%= f.label :cost_volatility,
              "Cost Volatility",
              class: "block text-sm text-gray-700 mb-1" %>
      <%= f.number_field :cost_volatility,
                     step: "0.01",
                     min: "0",
                     max: "1",
                     class:
                       "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
      <p class="mt-1 text-xs text-gray-500">E.g., 0.10 for ±10% variance</p>
    </div>
    
    <div>
      <%= f.label :revenue_volatility,
              "Revenue Volatility",
              class: "block text-sm text-gray-700 mb-1" %>
      <%= f.number_field :revenue_volatility,
                     step: "0.01",
                     min: "0",
                     max: "1",
                     class:
                       "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
      <p class="mt-1 text-xs text-gray-500">Price uncertainty factor</p>
    </div>
    
    <div>
      <%= f.label :monte_carlo_iterations,
              "Simulation Iterations",
              class: "block text-sm text-gray-700 mb-1" %>
      <%= f.number_field :monte_carlo_iterations,
                     step: "1000",
                     min: "1000",
                     class:
                       "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
      <p class="mt-1 text-xs text-gray-500">Default: 10,000 iterations</p>
    </div>
  </div>
</div>

      </div>
   </div>
    <!-- Submit Button -->
    <div class="flex justify-end">
      <%= f.submit "Calculate Costs & Sustainability Metrics",
               class:
                 "px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 transition-colors cursor-pointer" %>
    </div>
  <% end %>
</div>

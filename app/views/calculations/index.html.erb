<div class="space-y-6">
  <!-- Header Section -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
    <h2 class="text-2xl font-bold text-gray-900 mb-2">
      Cost & Sustainability Calculator
    </h2>
    <p class="text-gray-600">
      Analyze SLM production costs, investment viability, and environmental
      impact with real-time data integration.
    </p>
  </div>

  <%= form_with model: @slicing_data, url: calculations_path, class: "space-y-6" do |f| %>
    <!-- Machine Selection -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">
        1. Select Machine
      </h3>

      <% if f.object.errors[:machine].any? %>
        <div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
          <p class="text-sm text-red-800"><%= f.object.errors[:machine].first %></p>
        </div>
      <% end %>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <% @machines.each do |machine| %>
          <label class="cursor-pointer">
            <input
              type="radio"
              name="slicing_datum[machine_id]"
              value="<%= machine.id %>"
              class="peer hidden"
              required
            >
            <div
              class="
                border-2 border-gray-200 rounded-lg p-4 peer-checked:border-blue-500
                peer-checked:bg-blue-50 hover:border-blue-300 transition-colors
              "
            >
              <div class="flex items-center justify-between mb-3">
                <h4 class="font-semibold text-gray-900"><%= machine.name %></h4>
                <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">
                  <%= machine.model_number %>
                </span>
              </div>

              <dl class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <dt class="text-gray-500">Build Volume:</dt>
                  <dd class="font-medium text-gray-900">
                    <%= machine.build_volume_x.to_i %>×<%= machine.build_volume_y.to_i %><%= machine.build_volume_z.to_i %>
                    mm
                  </dd>
                </div>

                <div class="flex justify-between">
                  <dt class="text-gray-500">Laser Power:</dt>
                  <dd class="font-medium text-gray-900"><%= machine.laser_power.to_i %>
                    W</dd>
                </div>

                <div class="flex justify-between">
                  <dt class="text-gray-500">Purchase Price:</dt>
                  <dd class="font-medium text-gray-900">R
                    <%= number_to_human(machine.purchase_price, precision: 2) %></dd>
                </div>
              </dl>
            </div>
          </label>
        <% end %>
      </div>
    </div>
    <!-- Material Selection -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">
        2. Select Material
      </h3>

      <% if f.object.errors[:material].any? %>
        <div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
          <p class="text-sm text-red-800"><%= f.object.errors[:material].first %></p>
        </div>
      <% end %>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <% @materials.each do |material| %>
          <label class="cursor-pointer">
            <input
              type="radio"
              name="slicing_datum[material_id]"
              value="<%= material.id %>"
              class="peer hidden"
              required
            >
            <div
              class="
                border-2 border-gray-200 rounded-lg p-4 peer-checked:border-green-500
                peer-checked:bg-green-50 hover:border-green-300 transition-colors
              "
            >
              <div class="mb-3">
                <h4 class="font-semibold text-gray-900"><%= material.name %></h4>
                <p class="text-xs text-gray-500 mt-1"><%= material.code %></p>
              </div>

              <dl class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <dt class="text-gray-500">Density:</dt>
                  <dd class="font-medium text-gray-900"><%= material.density %>
                    g/cm³</dd>
                </div>

                <div class="flex justify-between">
                  <dt class="text-gray-500">Price:</dt>
                  <dd class="font-medium text-gray-900">R
                    <%= material.raw_material_price.to_i %>/kg</dd>
                </div>

                <div class="flex justify-between">
                  <dt class="text-gray-500">Recycling:</dt>
                  <dd class="font-medium text-gray-900"><%= (material.recycling_efficiency * 100).to_i %>%</dd>
                </div>

                <div class="flex justify-between">
                  <dt class="text-gray-500">Carbon:</dt>
                  <dd class="font-medium text-gray-900"><%= material.embodied_carbon %>
                    kg CO₂</dd>
                </div>
              </dl>
            </div>
          </label>
        <% end %>
      </div>
    </div>
    <!-- Part Geometry Parameters -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">
        3. Enter Part Geometry Parameters
      </h3>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div>
          <%= f.label :part_name,
                  "Part Name",
                  class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= f.text_field :part_name,
                       class:
                         "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",
                       placeholder: "e.g., Bracket-001" %>
          <% if f.object.errors[:part_name].any? %>
            <p class="mt-1 text-sm text-red-600"><%= f.object.errors[:part_name].first %></p>
          <% end %>
        </div>

        <div>
          <%= f.label :part_volume,
                  "Part Volume (mm³)",
                  class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= f.number_field :part_volume,
                         step: "0.01",
                         class:
                           "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",
                         placeholder: "e.g., 12500.00" %>
          <% if f.object.errors[:part_volume].any? %>
            <p class="mt-1 text-sm text-red-600"><%= f.object.errors[:part_volume].first %></p>
          <% end %>
        </div>

        <div>
          <%= f.label :part_height,
                  "Part Height (mm)",
                  class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= f.number_field :part_height,
                         step: "0.01",
                         class:
                           "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",
                         placeholder: "e.g., 45.00" %>
          <% if f.object.errors[:part_height].any? %>
            <p class="mt-1 text-sm text-red-600"><%= f.object.errors[:part_height].first %></p>
          <% end %>
        </div>

        <div>
          <%= f.label :surface_area,
                  "Surface Area (mm²)",
                  class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= f.number_field :surface_area,
                         step: "0.01",
                         class:
                           "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",
                         placeholder: "e.g., 8500.00" %>
          <% if f.object.errors[:surface_area].any? %>
            <p class="mt-1 text-sm text-red-600"><%= f.object.errors[:surface_area].first %></p>
          <% end %>
        </div>

        <div>
          <%= f.label :support_volume,
                  "Support Volume (mm³)",
                  class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= f.number_field :support_volume,
                         step: "0.01",
                         value: 0,
                         class:
                           "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",
                         placeholder: "e.g., 1500.00" %>
          <% if f.object.errors[:support_volume].any? %>
            <p class="mt-1 text-sm text-red-600"><%= f.object.errors[:support_volume].first %></p>
          <% end %>
        </div>

        <div>
          <%= f.label :layer_thickness,
                  "Layer Thickness (mm)",
                  class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= f.number_field :layer_thickness,
                         step: "0.001",
                         value: 0.03,
                         class:
                           "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",
                         placeholder: "e.g., 0.03" %>
          <% if f.object.errors[:layer_thickness].any? %>
            <p class="mt-1 text-sm text-red-600"><%= f.object.errors[:layer_thickness].first %></p>
          <% end %>
        </div>
      </div>
    </div>
    <!-- Production Parameters -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">
        4. Production Configuration
      </h3>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <%= f.label :parts_per_build,
                  "Parts per Build",
                  class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= f.number_field :parts_per_build,
                         value: 1,
                         min: 1,
                         class:
                           "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" %>
          <p class="mt-1 text-xs text-gray-500">How many parts will be produced in a single build?</p>
          <% if f.object.errors[:parts_per_build].any? %>
            <p class="mt-1 text-sm text-red-600"><%= f.object.errors[:parts_per_build].first %></p>
          <% end %>
        </div>

        <div>
          <%= f.label :material_utilization,
                  "Material Utilization Efficiency",
                  class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= f.number_field :material_utilization,
                         step: "0.01",
                         value: 0.6,
                         min: 0.1,
                         max: 1.0,
                         class:
                           "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" %>
          <p class="mt-1 text-xs text-gray-500">Typical range: 0.5-0.7 (50-70% efficiency)</p>
          <% if f.object.errors[:material_utilization].any? %>
            <p class="mt-1 text-sm text-red-600"><%= f.object.errors[:material_utilization].first %></p>
          <% end %>
        </div>
      </div>
    </div>
    <!-- Advanced Parameters (Collapsible) -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-900">
          5. Advanced Parameters (Optional)
        </h3>
        <button
          type="button"
          onclick="document.getElementById('advanced-params').classList.toggle('hidden')"
          class="text-sm text-blue-600 hover:text-blue-800"
        >
          Toggle Advanced Settings
        </button>
      </div>

      <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
        <div class="flex items-start">
          <%= f.check_box :use_custom_parameters, class: "mt-1 mr-2" %>
          <%= f.label :use_custom_parameters, class: "text-sm text-blue-800" do %>
            <span class="font-medium">Use custom parameters for this analysis</span>
            <span class="block text-xs mt-1">
              By default, global parameters are used. Enable this to override
              with custom values below.
            </span>
          <% end %>
        </div>
      </div>

      <div id="advanced-params" class="hidden space-y-6">
        <!-- Economic Parameters -->
        <div>
          <h4 class="font-medium text-gray-900 mb-3">Economic Parameters</h4>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <%= f.label :electricity_rate,
                      "Electricity Rate (R/kWh)",
                      class: "block text-sm text-gray-700 mb-1" %>
              <%= f.number_field :electricity_rate,
                             step: "0.01",
                             class:
                               "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
            </div>
            <div>
              <%= f.label :labor_rate,
                      "Labor Rate (R/hr)",
                      class: "block text-sm text-gray-700 mb-1" %>
              <%= f.number_field :labor_rate,
                             step: "0.01",
                             class:
                               "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
            </div>
            <div>
              <%= f.label :annual_operating_hours,
                      "Annual Operating Hours",
                      class: "block text-sm text-gray-700 mb-1" %>
              <%= f.number_field :annual_operating_hours,
                             step: "1",
                             class:
                               "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
            </div>
          </div>
        </div>
        <!-- Gas & Consumables -->
        <div>
          <h4 class="font-medium text-gray-900 mb-3">Gas & Consumables</h4>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <%= f.label :inert_gas_price,
                      "Inert Gas Price (R/m³)",
                      class: "block text-sm text-gray-700 mb-1" %>
              <%= f.number_field :inert_gas_price,
                             step: "0.01",
                             class:
                               "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
            </div>
            <div>
              <%= f.label :gas_consumption_per_hour,
                      "Gas Consumption (m³/hr)",
                      class: "block text-sm text-gray-700 mb-1" %>
              <%= f.number_field :gas_consumption_per_hour,
                             step: "0.001",
                             class:
                               "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
            </div>
            <div>
              <%= f.label :waste_disposal_cost_per_kg,
                      "Waste Disposal (R/kg)",
                      class: "block text-sm text-gray-700 mb-1" %>
              <%= f.number_field :waste_disposal_cost_per_kg,
                             step: "0.01",
                             class:
                               "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
            </div>
          </div>
        </div>
        <!-- Facility Costs -->
        <div>
          <h4 class="font-medium text-gray-900 mb-3">Facility Costs (Annual)</h4>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <%= f.label :annual_rent, "Rent (R/year)", class: "block text-sm text-gray-700 mb-1" %>
              <%= f.number_field :annual_rent,
                             step: "0.01",
                             class:
                               "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
            </div>
            <div>
              <%= f.label :annual_utilities,
                      "Utilities (R/year)",
                      class: "block text-sm text-gray-700 mb-1" %>
              <%= f.number_field :annual_utilities,
                             step: "0.01",
                             class:
                               "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
            </div>
            <div>
              <%= f.label :annual_admin,
                      "Admin (R/year)",
                      class: "block text-sm text-gray-700 mb-1" %>
              <%= f.number_field :annual_admin,
                             step: "0.01",
                             class:
                               "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
            </div>
          </div>
        </div>
        <!-- Digital Infrastructure -->
        <div>
          <h4 class="font-medium text-gray-900 mb-3">Digital Infrastructure (Annual)</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <%= f.label :annual_software_cost,
                      "Software Licenses (R/year)",
                      class: "block text-sm text-gray-700 mb-1" %>
              <%= f.number_field :annual_software_cost,
                             step: "0.01",
                             class:
                               "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
            </div>
            <div>
              <%= f.label :annual_hpc_cost,
                      "HPC Systems (R/year)",
                      class: "block text-sm text-gray-700 mb-1" %>
              <%= f.number_field :annual_hpc_cost,
                             step: "0.01",
                             class:
                               "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
            </div>
          </div>
        </div>

        <!-- Maintenence -->
        <div>
          <h4 class="font-medium text-gray-900 mb-3">Maintenance<h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <%= f.label :preventive_maintenance_cost,
                      "Preventive Maintenance Cost (R)",
                      class: "block text-sm text-gray-700 mb-1" %>
              <%= f.number_field :preventive_maintenance_cost,
                             step: "0.01",
                             class:
                               "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
            </div>
            <div>
              <%= f.label :preventive_maintenance_frequency,
                      class: "block text-sm text-gray-700 mb-1" %>
              <%= f.number_field :preventive_maintenance_frequency,
                             step: "1",
                             class:
                               "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
            </div>

            <div>
              <%= f.label :corrective_maintenance_cost,
                      "Corrective Maintenance Cost (R)",
                      class: "block text-sm text-gray-700 mb-1" %>
              <%= f.number_field :corrective_maintenance_cost,
                             step: "0.01",
                             class:
                               "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
            </div>
            <div>
              <%= f.label :corrective_maintenance_frequency,
                      class: "block text-sm text-gray-700 mb-1" %>
              <%= f.number_field :corrective_maintenance_frequency,
                             step: "1",
                             class:
                               "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
            </div>
          </div>
        </div>
        <!-- Build Parameters -->
        <div>
          <h4 class="font-medium text-gray-900 mb-3">Build & Process Parameters</h4>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <%= f.label :machine_power_consumption,
                      "Machine Power (kW)",
                      class: "block text-sm text-gray-700 mb-1" %>
              <%= f.number_field :machine_power_consumption,
                             step: "0.1",
                             class:
                               "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
            </div>
            <div>
              <%= f.label :setup_time_hours,
                      "Setup Time (hours)",
                      class: "block text-sm text-gray-700 mb-1" %>
              <%= f.number_field :setup_time_hours,
                             step: "0.1",
                             class:
                               "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
            </div>
            <div>
              <%= f.label :post_processing_time_per_part,
                      "Post-Processing (hrs/part)",
                      class: "block text-sm text-gray-700 mb-1" %>
              <%= f.number_field :post_processing_time_per_part,
                             step: "0.1",
                             class:
                               "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
            </div>
          </div>
        </div>
        <!-- Sustainability -->
        <div>
          <h4 class="font-medium text-gray-900 mb-3">Sustainability Parameters</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <%= f.label :grid_emission_factor,
                      "Grid Emission Factor (kg CO₂/kWh)",
                      class: "block text-sm text-gray-700 mb-1" %>
              <%= f.number_field :grid_emission_factor,
                             step: "0.001",
                             class:
                               "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" %>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Submit Button -->
    <div class="flex justify-end">
      <%= f.submit "Calculate Costs & Sustainability Metrics",
               class:
                 "px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 transition-colors cursor-pointer" %>
    </div>
  <% end %>
</div>
